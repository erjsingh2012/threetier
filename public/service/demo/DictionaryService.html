<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dictionary Service Demo</title>
  <style>
    :root {
      --bg: #fefefe;
      --primary: #4CAF50;
      --primary-dark: #3a8c40;
      --secondary: #ff9800;
      --text: #222;
      --muted: #666;
      --card-bg: #fff;
      --border: #ddd;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
    }

    h1 {
      font-size: 1.8rem;
      margin: 0 0 1rem;
      text-align: center;
      color: var(--primary-dark);
    }

    h2 {
      font-size: 1.2rem;
      margin: 1.5rem 0 0.75rem;
      color: var(--secondary);
    }

    input,
    button,
    select {
      width: 100%;
      padding: 14px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-size: 1rem;
      transition: 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    button:hover {
      background: var(--primary-dark);
    }

    select {
      background: var(--primary);
      color: #fff;
      font-weight: 500;
    }

    #result,
    #cache,
    #wordGroups {
      background: var(--card-bg);
      padding: 16px;
      margin-top: 12px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      font-size: 15px;
      line-height: 1.5;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 600px) {
      body {
        padding: 24px;
        max-width: 720px;
        margin: auto;
      }

      .input-group {
        flex-direction: row;
        align-items: center;
      }

      input {
        flex: 1;
        margin: 0;
      }

      button {
        width: auto;
        margin: 0;
      }

      select {
        width: auto;
      }
    }

    /* Word cards inside results */
    .meaning-card {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 10px;
      background: #f9fff9;
    }

    .part-of-speech {
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 6px;
      text-transform: capitalize;
    }

    .example {
      margin-top: 6px;
      font-style: italic;
      color: var(--muted);
    }

    .word-header {
      margin-bottom: 12px;
    }

    .word-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .phonetic {
      margin-top: 4px;
      color: var(--muted);
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <h1>üìñ Word Explorer</h1>
  <div class="input-group">
    <input id="wordInput" type="text" placeholder="Enter a word..." />
    <button id="lookupBtn">Lookup</button>
  </div>

  <h2>Result</h2>
  <div id="result">No lookup yet.</div>

  <h2>Cache</h2>
  <div id="cache">No cached words yet.</div>

  <h2>Browse by Word Length</h2>
  <select id="wordLengthSelect">
    <option value="">-- Select Length --</option>
    <option value="2">2 Letter Words</option>
    <option value="3">3 Letter Words</option>
    <option value="4">4 Letter Words</option>
    <option value="5">5 Letter Words</option>
    <option value="6">6 Letter Words</option>
    <option value="7">7 Letter Words</option>
    <option value="8">8 Letter Words</option>
    <option value="9">9 Letter Words</option>
    <option value="10">10 Letter Words</option>
  </select>
  <div id="wordGroups">Choose a word length to view words.</div>

  <script type="module">
    import { StorageManager } from "../../resources/managers/StorageManager.js";
    import { ApiManager } from "../../resources/managers/ApiManager.js";
    import { DataFileManager } from "../../resources/managers/DataFileManager.js";
    import { DictionaryService } from "../DictionaryService.js";

    const storageManager = new StorageManager();
    const apiManager = new ApiManager("https://example.com/api");
    const dataFileManager = new DataFileManager();
    const dictionaryService = new DictionaryService(storageManager, apiManager, dataFileManager);

    await dictionaryService.init();

    const resultDiv = document.getElementById("result");
    const cacheDiv = document.getElementById("cache");
    const wordGroupsDiv = document.getElementById("wordGroups");
    const lookupBtn = document.getElementById("lookupBtn");
    const wordInput = document.getElementById("wordInput");
    const wordLengthSelect = document.getElementById("wordLengthSelect");

    function updateCacheDisplay() {
      const words = dictionaryService.getCachedWords(30);
      cacheDiv.textContent = words.length ? words.join(", ") : "No cached words yet.";
    }

    lookupBtn.addEventListener("click", async () => {
      const word = wordInput.value.trim();
      if (!word) return alert("Enter a word first!");

      try {
        const raw = await dictionaryService.lookup(word);
        const simplified = toSimplified(raw);

        resultDiv.innerHTML = simplified
          ? renderWordHTML(simplified)
          : `No definition found for '${word}'`;
      } catch (err) {
        console.error("Lookup error:", err);
        resultDiv.innerHTML = `<p style="color:red;">‚ùå Failed to fetch definition.</p>`;
      }
    });

    function toSimplified(data) {
      if (!data) return null;
      if (!Array.isArray(data) && data.word && Array.isArray(data.meanings)) {
        return data;
      }
      if (!Array.isArray(data) || data.length === 0) return null;

      const entry = data[0];
      const phonetic =
        entry.phonetic ||
        (Array.isArray(entry.phonetics) && entry.phonetics.find(p => p.text)?.text) ||
        "";

      const meanings = (entry.meanings || [])
        .map(m => {
          const def = m.definitions?.[0];
          if (!def) return null;
          return {
            partOfSpeech: m.partOfSpeech || "",
            definition: def.definition || "",
            example: def.example || ""
          };
        })
        .filter(Boolean);

      return { word: entry.word || "", phonetic, meanings };
    }

    function renderWordHTML(simplified) {
      if (!simplified) return "<p>‚ùå No result.</p>";
      const { word, phonetic, meanings } = simplified;

      const header = `
        <div class="word-header">
          <div class="word-title">${word || ""}</div>
          ${phonetic ? `<div class="phonetic">${phonetic}</div>` : ""}
        </div>
      `;

      if (!meanings || meanings.length === 0) {
        return header + `<p>No meanings available.</p>`;
      }

      const items = meanings.map(m => `
        <div class="meaning-card">
          <div class="part-of-speech">${m.partOfSpeech || "‚Äî"}</div>
          <div>${m.definition || ""}</div>
          ${m.example ? `<div class="example">Example: ${m.example}</div>` : ""}
        </div>
      `).join("");

      return header + items;
    }

    wordLengthSelect.addEventListener("change", () => {
      const length = parseInt(wordLengthSelect.value, 10);
      if (!length) {
        wordGroupsDiv.textContent = "Choose a word length to view words.";
        return;
      }
      const words = dictionaryService.getCachedWordsOfLenth(30, length);
      wordGroupsDiv.textContent = words.length
        ? `${length}-letter words:\n${words.join(", ")}`
        : `No ${length}-letter words in cache yet.`;
    });

    updateCacheDisplay();
  </script>
</body>
</html>
